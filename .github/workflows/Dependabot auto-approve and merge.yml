name: Dependabot Auto-Approve and Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

# Elevate the default GITHUB_TOKEN permissions
permissions:
  pull-requests: write
  contents: write

jobs:
  approve-and-merge:
    name: Approve and Merge Dependabot PRs
    runs-on: ubuntu-slim

    # Ensures this workflow only runs for the official Dependabot account
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Assign PR to HotCakeX
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          # Query the PR to check current assignees
          IS_ASSIGNED=$(gh pr view "$PR_URL" --json assignees --jq '.assignees | map(.login) | contains(["HotCakeX"])')

          if [ "$IS_ASSIGNED" = "true" ]; then
            echo "âœ… HotCakeX is already assigned to this PR."
          else
            echo "ðŸ”„ Assigning HotCakeX to the PR..."
            gh pr edit "$PR_URL" --add-assignee "HotCakeX"
          fi

      - name: Approve PR as GitHub Actions Bot
        env:
          # Uses the default token to approve as github-actions[bot]
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "âœ… Approving the PR as github-actions[bot]..."
          gh pr review "$PR_URL" --approve

      - name: Approve PR as Code Owner
        env:
          # We use a Personal Access Token (PAT) belonging to the Code Owner (HotCakeX) here.
          # This ensures the approval satisfies the "require_code_owner_review" branch protection rule.
          GH_TOKEN: ${{ secrets.HOTCAKEX_PAT }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "âœ… Approving the PR as Code Owner..."
          gh pr review "$PR_URL" --approve

      - name: Enable Auto-Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "âœ… Enabling auto-merge for the PR..."
          # --auto enables native GitHub auto-merge (defers merging until required checks pass).
          # --squash and --delete-branch maintain the merge strategy.
          gh pr merge "$PR_URL" --auto --squash --delete-branch
